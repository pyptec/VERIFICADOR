C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE LINTECH
OBJECT MODULE PLACED IN .\Objects\lintech.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE lintech.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\lintech.lst) TABS(2) OBJECT(.\Objects\lintech.obj)

line level    source

   1          #include<lintech.h>
   2          
   3          /*----------------------------------------------------------------------------
   4           definiciones de lintech en la inicializacion de expedidor o verificador
   5          ------------------------------------------------------------------------------*/
   6          
   7          #define INICIA_LINTECH          0x30
   8          #define SEQ_CAPTURE_DATOS_INI   0x31
   9          #define GRABA_EEPROM            0x32
  10          #define SEQ_CAPTURA_OK_EEPROM   0X33
  11          #define FIN_OK                  0x00
  12          
  13          /*----------------------------------------------------------------------------
  14           definiciones de lintech en el comando Check_Status
  15          ------------------------------------------------------------------------------*/
  16          
  17          #define S_DETAIL        0x31
  18          #define S_NORMAL        0x30
  19          
  20          /*------------------------------------------------------------------------------
  21           definiciones de lintech en el comando Card_Insercion
  22          ------------------------------------------------------------------------------*/
  23          
  24          #define Habilita        0x30
  25          #define Inhabilita      0x31
  26          
  27          /*------------------------------------------------------------------------------
  28          Definicion de Lintech en el comando Inicializa
  29          ------------------------------------------------------------------------------*/
  30          
  31          #define TO_FRONT        '0'
  32          #define CAPTURE_BOX     '1'
  33          #define SIN_MOVIMIENTO  '3'
  34          
  35          /*------------------------------------------------------------------------------
  36          Definicion de Lintech en el comando mover tarjeta (Mov_Card)
  37          ------------------------------------------------------------------------------*/
  38          
  39          #define   MovPos_Front        '0'   
  40          #define   MovPos_IC           '1'
  41          #define   MovPos_RF           '2'
  42          #define   MovPos_Capture      '3'
  43          #define   MovPos_EjectFront   '9'
  44          
  45          /*------------------------------------------------------------------------------
  46          Definicion de la trama Lintech de las respuestas de los cmd
  47          ------------------------------------------------------------------------------*/
  48          
  49          #define Pos_TipoResp        4
  50          #define Pos_Length          3
  51          #define Pos_St0             7
  52          #define Pos_St1             8
  53          #define Pos_St2             9
  54          #define Pos_IniDatMF        0x0a
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 2   

  55          #define Card_type_H         0x0a
  56          #define Card_type_L         0x0b
  57          
  58          /*----------------------------------------------------------------------------
  59          definicion de datos de trama lintech
  60          ------------------------------------------------------------------------------*/
  61          
  62          #define   ETX               03
  63          #define   STX_LINTECH       0xf2
  64          
  65          /*----------------------------------------------------------------------------
  66          tiempo de delay entre funciones
  67          ------------------------------------------------------------------------------*/
  68          
  69          #define   TIME_CARD         50    //100
  70          #define   TIME_CARD_WR      150
  71          
  72          /*----------------------------------------------------------------------------
  73          definicion de recepcion serial 
  74          ------------------------------------------------------------------------------*/
  75          
  76          #define  ESPERA_RX          0           //espera el primer cmd de recepcion del verificado 
  77          
  78          /*externo bit*/
  79          
  80          extern bit buffer_ready;
  81          
  82          /*variables externas*/
  83          
  84          extern unsigned char g_cEstadoComSoft;
  85          extern unsigned char ValTimeOutCom;
  86          extern unsigned char g_cEstadoComSeqMF;
  87          extern unsigned char g_cContByteRx;
  88          
  89          /*FUNCIONES PROTOTIPO*/
  90          extern void Debug_txt_Tibbo(unsigned char * str);
  91          extern void DebugBufferMF(unsigned char *str,unsigned char num_char,char io);
  92          extern void EscribirCadenaSoft_buffer(unsigned char *buffer,unsigned char tamano_cadena);
  93          extern void Debug_chr_Tibbo(unsigned char Dat);
  94          extern unsigned char Dir_board();
  95          
  96          enum Tipos_MF_TIPO_TARJETA{
  97            INACTIVA,         
  98            ROTACION,           
  99            MENSUALIDAD,
 100            PREPAGO,
 101            CORTESIA,
 102            LOCATARIO,
 103            TARJETA_PERDIDA = 0X10,
 104            INHABILITADA = 0X11
 105          };
 106          
 107          enum expedidor {
 108           fecha_Int_Ano,
 109           fecha_Int_Mes, 
 110           fecha_Int_Dia, 
 111           fecha_Int_Hora,
 112           fecha_Int_Min,   
 113           Tipo_Tarjeta,
 114           Apb,
 115           Horario,
 116           Pico_Placa,
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 3   

 117           Type_Vehiculo,
 118           Uid_0,
 119           Uid_1,
 120           Uid_2,
 121           Uid_3,
 122           Expira_ano,
 123           Expira_mes,
 124           Expira_dia
 125           
 126          };
 127          
 128          /*----------------------------------------------------------------------------
 129          funcion de inicializacion del transporte
 130          
 131          ------------------------------------------------------------------------------*/
 132          
 133          void Inicializa(unsigned char TipoMovimiento)
 134          {
 135   1        unsigned char j, bcc;
 136   1        unsigned char g_scArrTxComSoft[10];
 137   1        bcc=0;
 138   1        if ((TipoMovimiento==SIN_MOVIMIENTO)||(TipoMovimiento==TO_FRONT)||(TipoMovimiento==CAPTURE_BOX))
 139   1        {
 140   2          
 141   2          Debug_txt_Tibbo((unsigned char *) "Incializa Dispensador\r\n");
 142   2          
 143   2          g_scArrTxComSoft[0]=STX_LINTECH;
 144   2          g_scArrTxComSoft[1]=0X00;
 145   2          g_scArrTxComSoft[2]=0X00;
 146   2          g_scArrTxComSoft[3]=0X03;
 147   2          g_scArrTxComSoft[4]='C';
 148   2          g_scArrTxComSoft[5]='0';
 149   2          g_scArrTxComSoft[6]=TipoMovimiento;
 150   2          g_scArrTxComSoft[7]=ETX;
 151   2          for (j=0; j<8; j++)
 152   2          {
 153   3            bcc=g_scArrTxComSoft[j]^bcc;
 154   3          }
 155   2          g_scArrTxComSoft[8]=bcc;
 156   2          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 157   2          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 158   2          DebugBufferMF(g_scArrTxComSoft,9,0);                /*muestra la trama enviada al pto serie a debug por tibbo*/
 159   2          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);    /* envio la trama por el pto serie*/
 160   2          ValTimeOutCom=TIME_CARD;
 161   2        }
 162   1      }
 163          
 164          /*------------------------------------------------------------------------------
 165          cmd de lintech que responde en que estado de los sensores se encuentra
 166          
 167          (30) solo envia el resumen de los sensores
 168          (31) da un reporte detallado de los sensores
 169          ------------------------------------------------------------------------------*/
 170          
 171          void Check_Status(unsigned char Detalle)
 172          {
 173   1        unsigned char j, bcc;
 174   1        unsigned char g_scArrTxComSoft[10];
 175   1        Debug_txt_Tibbo((unsigned char *) "Check_Status\r\n");
 176   1      
 177   1        bcc=0;
 178   1      
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 4   

 179   1        g_scArrTxComSoft[0]=STX_LINTECH;
 180   1        g_scArrTxComSoft[1]=0X00;
 181   1        g_scArrTxComSoft[2]=0X00;
 182   1        g_scArrTxComSoft[3]=0X03;
 183   1        g_scArrTxComSoft[4]='C';
 184   1        g_scArrTxComSoft[5]='1';
 185   1        g_scArrTxComSoft[6]=Detalle;
 186   1        g_scArrTxComSoft[7]=ETX;
 187   1        for (j=0; j<8; j++)
 188   1        {
 189   2          bcc=g_scArrTxComSoft[j]^bcc;
 190   2        }
 191   1        g_scArrTxComSoft[8]=bcc;
 192   1        buffer_ready=0;
 193   1        g_cEstadoComSoft=ESPERA_RX;
 194   1        DebugBufferMF(g_scArrTxComSoft,9,0);
 195   1        EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);
 196   1        ValTimeOutCom=TIME_CARD;
 197   1      }
 198          
 199          /*------------------------------------------------------------------------------
 200          Procedimiento que habilita la insercion o inhabilita la insersion
 201          (31) inhabilita
 202          (30) habilita
 203          ------------------------------------------------------------------------------*/
 204          
 205          void Card_Insercion(char Tipo)
 206          {
 207   1        unsigned char j, bcc;
 208   1        unsigned char g_scArrTxComSoft[10];
 209   1        if (Tipo==Habilita)
 210   1        {
 211   2          Debug_txt_Tibbo((unsigned char *) "Habilita Insersion\r\n");
 212   2          g_scArrTxComSoft[6]=Habilita;
 213   2        }
 214   1        else
 215   1        {
 216   2          
 217   2          Debug_txt_Tibbo((unsigned char *) "Inhabilita Insersion\r\n");
 218   2          g_scArrTxComSoft[6]=Inhabilita;
 219   2        
 220   2        }
 221   1      
 222   1        bcc=0;
 223   1      
 224   1        g_scArrTxComSoft[0]=0xF2;
 225   1        g_scArrTxComSoft[1]=0X00;
 226   1        g_scArrTxComSoft[2]=0X00;
 227   1        g_scArrTxComSoft[3]=0X03;
 228   1        g_scArrTxComSoft[4]='C';
 229   1        g_scArrTxComSoft[5]='3';
 230   1      
 231   1        g_scArrTxComSoft[7]=ETX;
 232   1        for (j=0; j<8; j++)
 233   1        {
 234   2          bcc=g_scArrTxComSoft[j]^bcc;
 235   2        }
 236   1      
 237   1        g_scArrTxComSoft[8]=bcc;
 238   1      
 239   1        buffer_ready=0;
 240   1        g_cEstadoComSoft=ESPERA_RX;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 5   

 241   1        DebugBufferMF(g_scArrTxComSoft,9,0);
 242   1        EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);
 243   1        ValTimeOutCom=TIME_CARD;
 244   1      }
 245          
 246          /*------------------------------------------------------------------------------
 247          CMD q mueve la tarjeta 
 248            MovPos_Front        '0'   
 249            MovPos_IC           '1'
 250            MovPos_RF           '2'
 251            MovPos_Capture      '3'
 252            MovPos_EjectFront   '9'
 253          ------------------------------------------------------------------------------*/
 254          
 255          void Mov_Card(unsigned char Posicion)
 256          {
 257   1        unsigned char j, bcc;
 258   1        unsigned char g_scArrTxComSoft[10];
 259   1        bcc=0;
 260   1      
 261   1        if ((Posicion==MovPos_RF)||(Posicion==MovPos_IC)||(Posicion==MovPos_Front)||(Posicion==MovPos_EjectFront
             -)||(Posicion==MovPos_Capture))
 262   1        {
 263   2          if (Posicion==MovPos_RF)
 264   2          {
 265   3            Debug_txt_Tibbo((unsigned char *) "Moviendo Tarjeta a RF\r\n");
 266   3          }
 267   2          else if (Posicion==MovPos_IC)
 268   2          {
 269   3            Debug_txt_Tibbo((unsigned char *) "Moviendo Tarjeta a IC\r\n");
 270   3            }
 271   2          else if (Posicion==MovPos_Front)
 272   2          {
 273   3            Debug_txt_Tibbo((unsigned char *) "Moviendo Tarjeta a Bezel\r\n");
 274   3          }
 275   2          else if (Posicion==MovPos_EjectFront)
 276   2          {
 277   3            Debug_txt_Tibbo((unsigned char *) "Expulsando Tarjeta\r\n");
 278   3          }
 279   2          else if (Posicion==MovPos_Capture)
 280   2          {
 281   3            Debug_txt_Tibbo((unsigned char *) "Capturando Tarjeta\r\n");
 282   3          }
 283   2      
 284   2          g_scArrTxComSoft[0]=STX_LINTECH;
 285   2          g_scArrTxComSoft[1]=0X00;
 286   2          g_scArrTxComSoft[2]=0X00;
 287   2          g_scArrTxComSoft[3]=0X03;
 288   2          g_scArrTxComSoft[4]='C';
 289   2          g_scArrTxComSoft[5]='2';
 290   2          g_scArrTxComSoft[6]=Posicion;
 291   2          g_scArrTxComSoft[7]=ETX;
 292   2          for (j=0; j<8; j++)
 293   2          {
 294   3            bcc=g_scArrTxComSoft[j]^bcc;
 295   3          }
 296   2          g_scArrTxComSoft[8]=bcc;
 297   2          buffer_ready=0;
 298   2          g_cEstadoComSoft=ESPERA_RX;
 299   2          DebugBufferMF(g_scArrTxComSoft,9,0);
 300   2          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);
 301   2          ValTimeOutCom=TIME_CARD;        //TIME_CARD_WR;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 6   

 302   2        }
 303   1      
 304   1      }
 305          
 306          //*******************************************************************************************
 307          // rutina q mira el tipo de tarjeta si es valido para el uso  
 308          //*******************************************************************************************
 309          
 310          void Aut_Card_check_Status(void)
 311          {
 312   1      unsigned char j, bcc;
 313   1      unsigned char g_scArrTxComSoft[10];
 314   1            bcc=0;
 315   1        
 316   1        Debug_txt_Tibbo((unsigned char *) "Aut_Card_check_Status\r\n");
 317   1        
 318   1        g_scArrTxComSoft[0]=STX_LINTECH;
 319   1          g_scArrTxComSoft[1]=0X00;
 320   1          g_scArrTxComSoft[2]=0X00;
 321   1          g_scArrTxComSoft[3]=0X03;
 322   1          g_scArrTxComSoft[4]='C';
 323   1          g_scArrTxComSoft[5]=0x50;
 324   1          g_scArrTxComSoft[6]=0x31;
 325   1          g_scArrTxComSoft[7]=ETX;
 326   1            for (j=0; j<8; j++)
 327   1          {
 328   2            bcc=g_scArrTxComSoft[j]^bcc;
 329   2          }
 330   1          g_scArrTxComSoft[8]=bcc;
 331   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 332   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 333   1          DebugBufferMF(g_scArrTxComSoft,9,0);                /*muestra la trama enviada al pto serie a debug por tibbo*/
 334   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);    /* envio la trama por el pto serie*/
 335   1          ValTimeOutCom=TIME_CARD;
 336   1        } 
 337          
 338          /*------------------------------------------------------------------------------
 339          CMD q programa la clave en el verificador o transporte
 340          ------------------------------------------------------------------------------*/
 341          
 342            void Dwload_EEprom (void)
 343          {
 344   1        unsigned char j, bcc;
 345   1        unsigned char g_scArrTxComSoft[21];
 346   1        bcc=0;
 347   1        Debug_txt_Tibbo((unsigned char *) "Download MF EEprom\r\n");
 348   1        
 349   1        g_scArrTxComSoft[0]=0xF2;
 350   1        g_scArrTxComSoft[1]=0X00;
 351   1        g_scArrTxComSoft[2]=0X00;
 352   1        g_scArrTxComSoft[3]=0X0E;
 353   1        g_scArrTxComSoft[4]='C';
 354   1        g_scArrTxComSoft[5]=0x60;
 355   1        g_scArrTxComSoft[6]='3';
 356   1        g_scArrTxComSoft[7]=0x00;
 357   1        g_scArrTxComSoft[8]=0Xd0;
 358   1        g_scArrTxComSoft[9]=0X00;
 359   1        g_scArrTxComSoft[10]=0X01;
 360   1        g_scArrTxComSoft[11]=0x06;
 361   1        g_scArrTxComSoft[12]='3';
 362   1        g_scArrTxComSoft[13]='V';
 363   1        g_scArrTxComSoft[14]='0';
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 7   

 364   1        g_scArrTxComSoft[15]='p';
 365   1        g_scArrTxComSoft[16]='4';
 366   1        g_scArrTxComSoft[17]='r';
 367   1        g_scArrTxComSoft[18]=ETX;
 368   1        
 369   1        for (j=0; j<19; j++)
 370   1          {
 371   2            bcc=g_scArrTxComSoft[j]^bcc;
 372   2          }
 373   1          g_scArrTxComSoft[19]=bcc;
 374   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 375   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 376   1          DebugBufferMF(g_scArrTxComSoft,20,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 377   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,20);   /* envio la trama por el pto serie*/
 378   1          ValTimeOutCom=TIME_CARD;
 379   1      }
 380          
 381          /*------------------------------------------------------------------------------
 382          Funcion q verifica si la clave y la carga en el transporte
 383          ------------------------------------------------------------------------------*/
 384          
 385          void LoadVerify_EEprom(void)
 386          {
 387   1        unsigned char j, bcc;
 388   1        unsigned char g_scArrTxComSoft[15];
 389   1        bcc=0;
 390   1        Debug_txt_Tibbo((unsigned char *) "Carga y Verifica de EEprom\r\n");
 391   1      
 392   1      
 393   1        g_scArrTxComSoft[0]=0xF2;
 394   1        g_scArrTxComSoft[1]=0X00;
 395   1        g_scArrTxComSoft[2]=0X00;
 396   1        g_scArrTxComSoft[3]=0X07;
 397   1        g_scArrTxComSoft[4]='C';
 398   1        g_scArrTxComSoft[5]=0x60;
 399   1        g_scArrTxComSoft[6]='3';
 400   1        g_scArrTxComSoft[7]=0x00;
 401   1        g_scArrTxComSoft[8]=0x21;
 402   1          g_scArrTxComSoft[9]=0x00;
 403   1        g_scArrTxComSoft[10]=0x01;
 404   1        g_scArrTxComSoft[11]=ETX;
 405   1        g_scArrTxComSoft[12]=0xc6;
 406   1      
 407   1        
 408   1      
 409   1        for (j=0; j<13; j++)
 410   1          {
 411   2            bcc=g_scArrTxComSoft[j]^bcc;
 412   2          }
 413   1          g_scArrTxComSoft[13]=bcc;
 414   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 415   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 416   1          DebugBufferMF(g_scArrTxComSoft,14,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 417   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,14);   /* envio la trama por el pto serie*/
 418   1          ValTimeOutCom=TIME_CARD;
 419   1          
 420   1      }
 421          
 422          /*------------------------------------------------------------------------------
 423          Funcion q lee la MF dandole el sector y el bloque
 424          ------------------------------------------------------------------------------*/
 425          
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 8   

 426          void RD_MF(unsigned char Sector, unsigned char Bloque)
 427          {
 428   1      
 429   1        unsigned char j, bcc;
 430   1        unsigned char g_scArrTxComSoft[15];
 431   1        bcc=0;
 432   1      
 433   1        Debug_txt_Tibbo((unsigned char *) "Leyendo MF > Sector: ");
 434   1        Debug_chr_Tibbo(Sector);
 435   1        
 436   1        Debug_txt_Tibbo((unsigned char *) " Bloque: ");
 437   1        Debug_chr_Tibbo(Bloque);
 438   1        Debug_txt_Tibbo((unsigned char *) "\r\n");
 439   1      
 440   1      
 441   1        g_scArrTxComSoft[0]=0xF2;
 442   1        g_scArrTxComSoft[1]=0X00;                   
 443   1        g_scArrTxComSoft[2]=0X00;
 444   1        g_scArrTxComSoft[3]=0X08;
 445   1        g_scArrTxComSoft[4]='C';
 446   1        g_scArrTxComSoft[5]=0X60;
 447   1        g_scArrTxComSoft[6]='3';
 448   1        g_scArrTxComSoft[7]=0x00;
 449   1        g_scArrTxComSoft[8]=0xb0;
 450   1        g_scArrTxComSoft[9]=Sector;
 451   1        g_scArrTxComSoft[10]=Bloque;
 452   1        g_scArrTxComSoft[11]=0x01;
 453   1        g_scArrTxComSoft[12]=ETX;
 454   1      
 455   1        for (j=0; j<13; j++)
 456   1        {
 457   2          bcc=g_scArrTxComSoft[j]^bcc;
 458   2        }
 459   1        g_scArrTxComSoft[13]=bcc;
 460   1      
 461   1      
 462   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 463   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 464   1          DebugBufferMF(g_scArrTxComSoft,14,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 465   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,14);   /* envio la trama por el pto serie*/
 466   1          ValTimeOutCom=TIME_CARD;
 467   1      
 468   1      }
 469          
 470          /*------------------------------------------------------------------------------
 471          Funcion q lescribe la MF dandole el sector y el bloque y los datos
 472          ------------------------------------------------------------------------------*/
 473          
 474          
 475          void WR_MF(unsigned char Sector, unsigned char Bloque,unsigned char *buffer)     
 476             
 477          {
 478   1        unsigned char j, bcc;
 479   1        unsigned char g_scArrTxComSoft[31];
 480   1        bcc=0;
 481   1      
 482   1        Debug_txt_Tibbo((unsigned char *) "Escribe MF > Sector: ");
 483   1        Debug_chr_Tibbo(Sector);
 484   1        
 485   1        Debug_txt_Tibbo((unsigned char *) " Bloque: ");
 486   1        Debug_chr_Tibbo(Bloque);
 487   1        Debug_txt_Tibbo((unsigned char *) "\r\n");
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 9   

 488   1                                          
 489   1        g_scArrTxComSoft[0]=0xF2;
 490   1        g_scArrTxComSoft[1]=0X00;                   
 491   1        g_scArrTxComSoft[2]=0X00;
 492   1        g_scArrTxComSoft[3]=24;                                 /* Numero Datos a programar */ 
 493   1        
 494   1        g_scArrTxComSoft[4]='C';
 495   1        g_scArrTxComSoft[5]=0X60;
 496   1        g_scArrTxComSoft[6]='3';
 497   1        g_scArrTxComSoft[7]=0x00;
 498   1        g_scArrTxComSoft[8]=0xd1;
 499   1        g_scArrTxComSoft[9]=Sector;                             //Sector;
 500   1        g_scArrTxComSoft[10]=Bloque;                            //Bloque;
 501   1        g_scArrTxComSoft[11]=0x01;
 502   1      
 503   1        if(Sector!=2)
 504   1        { 
 505   2      /*------------------------------------------------------------------------------
 506   2      borro la fecha de entrada de entrada 
 507   2      ------------------------------------------------------------------------------*/
 508   2      
 509   2        g_scArrTxComSoft[12]=0x00;                              /*borro la fecha de entrada año mes dia hora minutos*/
 510   2        g_scArrTxComSoft[13]=0x00;
 511   2        g_scArrTxComSoft[14]=0x00;
 512   2        g_scArrTxComSoft[15]=0x00;
 513   2        g_scArrTxComSoft[16]=0x00;
 514   2      
 515   2      /*------------------------------------------------------------------------------
 516   2      borro los descuentos
 517   2      ------------------------------------------------------------------------------*/
 518   2        g_scArrTxComSoft[17]=0x00;
 519   2        g_scArrTxComSoft[18]=0x00;
 520   2        g_scArrTxComSoft[19]=0x00;
 521   2        
 522   2      /*------------------------------------------------------------------------------
 523   2      tipo de vehiculo
 524   2      ------------------------------------------------------------------------------*/
 525   2        if (*(buffer + Tipo_Tarjeta)!= MENSUALIDAD)
 526   2        {
 527   3        g_scArrTxComSoft[20]=0;
 528   3        }
 529   2        else
 530   2        {
 531   3          g_scArrTxComSoft[20]=(*(buffer + Horario) << 4) | *(buffer + Type_Vehiculo);
 532   3        }
 533   2      /*------------------------------------------------------------------------------
 534   2      direccion de BOArd_pcb de salida o puerta de salida
 535   2      ------------------------------------------------------------------------------*/  
 536   2        g_scArrTxComSoft[21]=0x0f&Dir_board();
 537   2        
 538   2      /*------------------------------------------------------------------------------
 539   2      programo el APB como salida (02) entrada(01)
 540   2      ------------------------------------------------------------------------------*/
 541   2      if (*(buffer + Tipo_Tarjeta)!= MENSUALIDAD)
 542   2        {
 543   3        g_scArrTxComSoft[22]=02;
 544   3        }
 545   2        else
 546   2        {
 547   3          g_scArrTxComSoft[22]=02;//*(buffer + Apb) ;
 548   3        }
 549   2      /*------------------------------------------------------------------------------
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 10  

 550   2      borro la fecha de salida 
 551   2      ------------------------------------------------------------------------------*/
 552   2      
 553   2        g_scArrTxComSoft[23]=0x00;                              /*borro la fecha de entrada año mes dia hora minutos*/
 554   2        g_scArrTxComSoft[24]=0x00;
 555   2        g_scArrTxComSoft[25]=0x00;
 556   2        g_scArrTxComSoft[26]=0x00;
 557   2        g_scArrTxComSoft[27]=0x00;
 558   2      
 559   2        }
 560   1          else 
 561   1          {
 562   2            for (j=12; j<=28; j++)
 563   2            {
 564   3              g_scArrTxComSoft[j]=0x00; 
 565   3            }
 566   2          }
 567   1      
 568   1      
 569   1      
 570   1      
 571   1        g_scArrTxComSoft[28]=ETX;
 572   1        
 573   1        for (j=0; j<=28; j++)
 574   1        {
 575   2          bcc=bcc^g_scArrTxComSoft[j];
 576   2        }
 577   1        g_scArrTxComSoft[29]=bcc;
 578   1      
 579   1        
 580   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 581   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 582   1          DebugBufferMF(g_scArrTxComSoft,30,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 583   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,30);   /* envio la trama por el pto serie*/
 584   1          ValTimeOutCom=TIME_CARD_WR;
 585   1        
 586   1      }
 587          //*******************************************************************************************
 588          // rutina q mira el tipo de tarjeta si es valido para el uso  
 589          //*******************************************************************************************
 590          
 591          void Unique_Identifier_UID(void)
 592          {
 593   1      unsigned char j, bcc;
 594   1      unsigned char g_scArrTxComSoft[10];
 595   1            bcc=0;
 596   1        
 597   1        Debug_txt_Tibbo((unsigned char *) "UID\r\n");
 598   1        
 599   1        g_scArrTxComSoft[0]=STX_LINTECH;
 600   1          g_scArrTxComSoft[1]=0X00;
 601   1          g_scArrTxComSoft[2]=0X00;
 602   1          g_scArrTxComSoft[3]=0X05;
 603   1          g_scArrTxComSoft[4]='C';
 604   1          g_scArrTxComSoft[5]=0x60;
 605   1          g_scArrTxComSoft[6]=0x30;
 606   1          g_scArrTxComSoft[7]=0x41;
 607   1          g_scArrTxComSoft[8]=0x30;
 608   1          g_scArrTxComSoft[9]=ETX;
 609   1            for (j=0; j<10; j++)
 610   1          {
 611   2            bcc=g_scArrTxComSoft[j]^bcc;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 11:49:11 PAGE 11  

 612   2          }
 613   1          g_scArrTxComSoft[10]=bcc;
 614   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 615   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 616   1          DebugBufferMF(g_scArrTxComSoft,11,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 617   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,11);   /* envio la trama por el pto serie*/
 618   1          ValTimeOutCom=TIME_CARD;
 619   1        } 
 620          void Power_off(void)
 621          {
 622   1      unsigned char j, bcc;
 623   1      unsigned char g_scArrTxComSoft[10];
 624   1            bcc=0;
 625   1        
 626   1        Debug_txt_Tibbo((unsigned char *) "POWER OFF UID\r\n");
 627   1        
 628   1        g_scArrTxComSoft[0]=STX_LINTECH;
 629   1          g_scArrTxComSoft[1]=0X00;
 630   1          g_scArrTxComSoft[2]=0X00;
 631   1          g_scArrTxComSoft[3]=0X03;
 632   1          g_scArrTxComSoft[4]='C';
 633   1          g_scArrTxComSoft[5]=0x60;
 634   1          g_scArrTxComSoft[6]=0x31;
 635   1          g_scArrTxComSoft[7]=ETX;
 636   1            for (j=0; j<8; j++)
 637   1          {
 638   2            bcc=g_scArrTxComSoft[j]^bcc;
 639   2          }
 640   1          g_scArrTxComSoft[8]=bcc;
 641   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 642   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 643   1          DebugBufferMF(g_scArrTxComSoft,9,0);                /*muestra la trama enviada al pto serie a debug por tibbo*/
 644   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);    /* envio la trama por el pto serie*/
 645   1          ValTimeOutCom=TIME_CARD;
 646   1      
 647   1      
 648   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1940    ----
   CONSTANT SIZE    =    353    ----
   XDATA SIZE       =   ----     172
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
